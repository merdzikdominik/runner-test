name: Deploy Windows apps with Ansible (Windows runner + Docker CLI)

on:
  workflow_dispatch:

jobs:
  deploy:
    # Twój self-hosted runner na Windowsie (w tej samej sieci co VM)
    runs-on: [self-hosted, windows]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Diag winrm check
        shell: powershell
        run: |
          $ip = (Get-Content ansible/inventory.ini | Select-String -Pattern 'ansible_host=').ToString().Split('=')[-1].Trim()
          $t = Test-NetConnection -ComputerName $ip -Port 5985
          $t | Select-Object ComputerName,RemoteAddress,RemotePort,TcpTestSucceeded
          if (-not $t.TcpTestSucceeded) { throw "No TCP to $ip:5985" }

      - name: Ansible in Linux container (Docker CLI)
        shell: powershell
        env:
          WIN_PASS: ${{ secrets.WIN_PASS }}
        run: |
          $bash = @'
          set -e
          cd /work/ansible
          
          if [ -f requirements.yml ]; then
            ansible-galaxy collection install -r requirements.yml
          fi
          
          # Dry ping
          ansible -i inventory.ini win -m ansible.windows.win_ping -v -e win_pass="${{ secrets.WIN_PASS }}"
          
          # Właściwy deploy (winget)
          ansible-playbook -i inventory.ini site.yml -v -e win_pass="${{ secrets.WIN_PASS }}"
          '@

          # Uruchom kontener z mapowaniem repo
          docker run --rm `
            -e WIN_PASS="$env:WIN_PASS" `
            -v "${{ github.workspace }}:/work" `
            -w "/work" `
            ghcr.io/coderanger/ansible:latest `
            bash -lc "$bash"
