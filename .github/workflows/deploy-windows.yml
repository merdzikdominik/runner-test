name: Deploy Windows apps (winget) — Variant A (self-hosted Windows)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, Windows]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Wstępny test łączności z VM (WinRM 5985)
        shell: powershell
        run: |
          Test-NetConnection -ComputerName 192.168.0.138 -Port 5985 | Format-List -Property ComputerName,RemoteAddress,RemotePort,TcpTestSucceeded

      - name: Run Ansible in Linux container (Docker Desktop)
        uses: addnab/docker-run-action@v3
        with:
          image: ghcr.io/coderanger/ansible:latest
          options: -v ${{ github.workspace }}:/work -w /work
          run: |
            set -e
            cd ansible

            # (opcjonalnie) doinstaluj kolekcje
            if [ -f requirements.yml ]; then
              ansible-galaxy collection install -r requirements.yml
            fi

            # Vault (jeśli używasz) – wstrzykujemy hasło do pliku
            if [ -n "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" ]; then
              echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > .vault
              chmod 600 .vault
              export ANSIBLE_VAULT_PASSWORD_FILE=.vault
            fi

            echo "== Ansible version =="
            ansible --version

            echo "== WinRM ping =="
            ansible -i inventory.ini win -m ansible.windows.win_ping -v \
              -e "win_pass=${{ secrets.WIN_PASS }}"

            echo "== Playbook deploy (winget) =="
            ansible-playbook -i inventory.ini site.yml -v \
              -e "win_pass=${{ secrets.WIN_PASS }}"
