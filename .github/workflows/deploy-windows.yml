name: Deploy Windows apps with Ansible (Windows runner + WSL)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, Windows]

    defaults:
      run:
        shell: wsl-bash {0}

    steps:
      - name: Setup WSL (use existing Ubuntu)
        uses: Vampire/setup-wsl@v6.0.0
        with:
          wsl-version: 1
          distribution: Ubuntu-22.04
          update: 'false'

      - uses: actions/checkout@v4

      - name: Install Ansible + Python in WSL (if needed)
        run: |
          set -e
          # Ansible + python3 + pip z apt
          sudo apt-get update
          sudo apt-get install -y ansible python3 python3-pip

      - name: Install Python deps for WinRM
        run: |
          set -e
          # pip już jest z pakietu python3-pip
          python3 -m pip install --user --upgrade pip
          python3 -m pip install --user \
            "pywinrm[credssp]>=0.4.3" \
            "requests-ntlm"
          # dorzuć ~/.local/bin do PATH dla przyszłych sesji
          echo 'export PATH=$HOME/.local/bin:$PATH' >> ~/.bashrc
          export PATH=$HOME/.local/bin:$PATH

      - name: Install Ansible collections
        run: |
          set -e
          cd ansible
          ansible-galaxy collection install -r requirements.yml
          
      - name: Create extra-vars (cmd on Windows)
        shell: cmd
        env:
          WIN_PASS: ${{ secrets.WIN_PASS2 }}
        run: |
          if "%WIN_PASS%"=="" ( echo Missing WIN_PASS & exit /b 1 )
          echo win_pass: "%WIN_PASS%" > ansible\extra-vars.yml

      - name: WinRM ping (ansible.windows.win_ping)
        run: |
          set -eu
          export PATH=$HOME/.local/bin:$PATH
          cd ansible
          ansible -i inventory.ini win -m ansible.windows.win_ping -v -e @extra-vars.yml

      - name: Run playbook (site.yml)
        run: |
          set -e
          export PATH=$HOME/.local/bin:$PATH
          cd ansible
          ansible-playbook -i inventory.ini site.yml -v -e @extra-vars.yml

      - name: Cleanup extra-vars
        if: always()
        run: |
          rm -f ansible/extra-vars.yml
