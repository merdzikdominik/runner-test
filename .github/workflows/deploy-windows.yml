name: Deploy Windows apps with Ansible (Windows runner + WSL)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, Windows]

    defaults:
      run:
        shell: wsl-bash {0}

    steps:
      - name: Setup WSL (use existing Ubuntu)
        uses: Vampire/setup-wsl@v6.0.0
        with:
          wsl-version: 1
          # PODAJ swoją dystrybucję, żeby nie ściągać Debiana przypadkiem:
          # distribution: Ubuntu-22.04
          update: 'false'

      - uses: actions/checkout@v4

      # (jeśli nie masz Ansible w obrazie WSL, doinstaluj:)
      - name: Install Ansible in WSL (if needed)
        run: |
          set -e
          if ! command -v ansible >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y ansible
          fi

      - name: Create extra-vars (win_pass)
        env:
          WIN_PASS: ${{ secrets.WIN_PASS2 }}
        run: |
          set -e
          cd ansible
          umask 077
          printf 'win_pass: %s\n' "$WIN_PASS" > extra-vars.yml

      - name: WinRM ping (ansible.windows.win_ping)
        run: |
          set -e
          export PATH=$HOME/.local/bin:$PATH
          cd ansible
          ansible -i inventory.ini win -m ansible.windows.win_ping -v -e @extra-vars.yml

      - name: Run playbook (site.yml)
        run: |
          set -e
          export PATH=$HOME/.local/bin:$PATH
          cd ansible
          ansible-playbook -i inventory.ini site.yml -v -e @extra-vars.yml
