name: Deploy Windows apps (winget) — WSL

on:
  workflow_dispatch:

jobs:
  deploy:
    # Twój self-hosted runner na Windowsie (te same etykiety co runner)
    runs-on: [self-hosted, Windows]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- WSL/Ubuntu setup (jednorazowo; po pierwszym uruchomieniu WSL może wymagać rebootu hosta) ---
      - name: Włącz funkcje WSL (jeśli brak)
        shell: powershell
        run: |
          $features = (dism.exe /online /Get-Features /Format:Table)
          if ($features -notmatch "Microsoft-Windows-Subsystem-Linux\s+Enabled") {
            dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
          }
          if ($features -notmatch "VirtualMachinePlatform\s+Enabled") {
            dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
          }
          wsl --set-default-version 2
          wsl --status

      - name: Zainstaluj/upewnij się, że jest Ubuntu-22.04 w WSL
        shell: powershell
        run: |
          if (-not (wsl -l -q | Select-String -SimpleMatch "Ubuntu-22.04")) {
            Write-Host "Installing Ubuntu-22.04..."
            wsl --install -d Ubuntu-22.04
            Write-Warning "Jeśli to pierwsza instalacja WSL/Ubuntu, może być wymagany reboot hosta. Uruchom ponownie maszynę i odpal workflow jeszcze raz."
          }
          # Pierwsze odpalenie, żeby dokończyć inicjalizację dystrybucji
          wsl -d Ubuntu-22.04 -- bash -lc "echo 'WSL ready'"

      # --- Wyznacz ścieżkę roboczą w WSL ---
      - name: Ustal WSL_WORKDIR (mapowanie GITHUB_WORKSPACE)
        shell: powershell
        run: |
          $p = $env:GITHUB_WORKSPACE
          $drive = $p.Substring(0,1).ToLower()
          $rest  = $p.Substring(2).Replace('\','/')
          $wsl   = "/mnt/$drive/$rest"
          "WSL_WORKDIR=$wsl" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "WSL_WORKDIR=$wsl"

      # --- Ansible w WSL ---
      - name: Zainstaluj Ansible + kolekcje w WSL
        shell: powershell
        run: |
          wsl -d Ubuntu-22.04 -- bash -lc "
            set -e
            sudo apt-get update
            sudo apt-get install -y python3-pip
            python3 -m pip install --user 'ansible-core==2.17.*' 'pywinrm>=0.4.3' 'pywinrm[credssp]'
            export PATH=\$HOME/.local/bin:\$PATH
            if [ -f \"$env:WSL_WORKDIR/ansible/requirements.yml\" ]; then
              ansible-galaxy collection install -r \"$env:WSL_WORKDIR/ansible/requirements.yml\"
            fi
          "

      # --- Diagnoza sieci do VM ---
      - name: WinRM check
        shell: powershell
        run: |
          Test-NetConnection -ComputerName 192.168.1.31 -Port 5985 |
            Select-Object ComputerName,RemoteAddress,RemotePort,TcpTestSucceeded

      # --- Test ping przez moduł WinRM ---
      - name: Test połączenia (ansible.windows.win_ping)
        shell: powershell
        env:
          WIN_PASS: ${{ secrets.WIN_PASS }}                         # hasło Administratora do VM
          ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }} # opcjonalnie
        run: |
          wsl -d Ubuntu-22.04 -- bash -lc "
            set -e
            export PATH=\$HOME/.local/bin:\$PATH
            cd \"$env:WSL_WORKDIR/ansible\"
            if [ -n \"\$ANSIBLE_VAULT_PASSWORD\" ]; then
              echo \"\$ANSIBLE_VAULT_PASSWORD\" > .vault && chmod 600 .vault
              export ANSIBLE_VAULT_PASSWORD_FILE=.vault
            fi
            ansible -i inventory.ini win -m ansible.windows.win_ping -v -e win_pass=\"\$WIN_PASS\"
          "

      # --- Właściwy deploy (winget) ---
      - name: Deploy apps
        shell: powershell
        env:
          WIN_PASS: ${{ secrets.WIN_PASS }}
          ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
        run: |
          wsl -d Ubuntu-22.04 -- bash -lc "
            set -e
            export PATH=\$HOME/.local/bin:\$PATH
            cd \"$env:WSL_WORKDIR/ansible\"
            if [ -n \"\$ANSIBLE_VAULT_PASSWORD\" ]; then
              echo \"\$ANSIBLE_VAULT_PASSWORD\" > .vault && chmod 600 .vault
              export ANSIBLE_VAULT_PASSWORD_FILE=.vault
            fi
            ansible-playbook -i inventory.ini site.yml -v -e win_pass=\"\$WIN_PASS\"
          "
