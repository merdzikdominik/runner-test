name: Deploy Windows apps with Ansible (Windows runner + WSL)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, Windows]

    steps:
      - uses: actions/checkout@v4

      - name: Compute WSL workdir
        shell: powershell
        run: |
          $p = $env:GITHUB_WORKSPACE
          $drive = $p.Substring(0,1).ToLower()
          $rest  = $p.Substring(2).Replace('\','/')
          $wsl   = "/mnt/$drive/$rest"
          "WSL_WORKDIR=$wsl" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "WSL_WORKDIR=$wsl"

      - name: Create extra-vars (win_pass)
        shell: wsl-bash_Ubuntu-20.04 {0}
        env:
          WIN_PASS: ${{ secrets.WIN_PASS2 }}
        run: |
          cd '$env:WSL_WORKDIR/ansible'
          umask 077
          printf 'win_pass: %s\n' '${WIN_PASS}' > extra-vars.yml

      - name: WinRM ping (ansible.windows.win_ping)
        shell: wsl-bash_Ubuntu-20.04 {0}
        run: |
          set -e
          export PATH=\$HOME/.local/bin:\$PATH
          cd '$env:WSL_WORKDIR/ansible'
          ansible -i inventory.ini win -m ansible.windows.win_ping -v -e @extra-vars.yml

      - name: Run playbook (site.yml)
        shell: wsl-bash_Ubuntu-20.04 {0}
        run: |
          export PATH=\$HOME/.local/bin:\$PATH
          cd '$env:WSL_WORKDIR/ansible'
          ansible-playbook -i inventory.ini site.yml -v -e @extra-vars.yml
