name: Deploy Windows apps with Ansible (Windows runner + WSL)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, Windows]

    defaults:
      run:
        shell: wsl-bash {0}

    steps:
      - name: Setup WSL (use existing Ubuntu)
        uses: Vampire/setup-wsl@v6.0.0
        with:
          wsl-version: 1
          distribution: Ubuntu-22.04 
          update: 'false'

      - uses: actions/checkout@v4

      # (jeśli nie masz Ansible w obrazie WSL, doinstaluj:)
      - name: Install Ansible in WSL (if needed)
        run: |
          set -e
          if ! command -v ansible >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y ansible
          fi
      - name: Install Python deps for WinRM
        run: |
          set -e
          python3 -m pip install --user \
            'xmltodict'
            'requests-ntlm'
          echo 'export PATH=$HOME/.local/bin:$PATH' >> ~/.bashrc
          export PATH=$HOME/.local/bin:$PATH
          
      - name: Create extra-vars (cmd on Windows)
        shell: cmd
        env:
          WIN_PASS: ${{ secrets.WIN_PASS2 }}
        run: |
          if "%WIN_PASS%"=="" ( echo Missing WIN_PASS & exit /b 1 )
          echo win_pass: "%WIN_PASS%" > ansible\extra-vars.yml
#      - name: Create extra-vars (win_pass) in WSL
#        env:
#          WIN_PASS: ${{ secrets.WIN_PASS2 }}
#        run: |
#          set -eu
#          cd ansible
#          # jeśli zmienna nie doszła do WSL, to tu wylecimy:
#          if [ -z "${WIN_PASS-}" ]; then
#            echo "WIN_PASS missing in WSL env" >&2
#            exit 1
#          fi
#          umask 077
#          printf 'win_pass: %s\n' "${WIN_PASS-}" > extra-vars.yml

      - name: WinRM ping (ansible.windows.win_ping)
        run: |
          set -eu
          cd ansible
          ansible -i inventory.ini win -m ansible.windows.win_ping -v -e @extra-vars.yml

      - name: Run playbook (site.yml)
        run: |
          set -e
          export PATH=$HOME/.local/bin:$PATH
          cd ansible
          ansible-playbook -i inventory.ini site.yml -v -e @extra-vars.yml



